<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8" />
  <title>å¤šåª’ä½“ç®¡ç†ä¸­å¿ƒ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #020617;
      --bg-soft: #020617;
      --surface: rgba(15, 23, 42, 0.95);
      --border: rgba(148, 163, 184, 0.35);
      --border-soft: rgba(148, 163, 184, 0.2);
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --accent-strong: #0ea5e9;
      --text: #e5e7eb;
      --text-muted: #9ca3af;
      --danger: #fb7185;
      --radius-lg: 18px;
      --radius-md: 12px;
      --shadow-soft: 0 18px 40px rgba(15, 23, 42, 0.8);
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", "Segoe UI", sans-serif;
      background: radial-gradient(circle at top left, #0f172a 0, #020617 55%, #000 100%);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: stretch;
      padding: 16px;
    }

    .app {
      max-width: 1200px;
      width: 100%;
      min-height: 92vh;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.95));
      border-radius: 24px;
      border: 1px solid rgba(148, 163, 184, 0.25);
      box-shadow: var(--shadow-soft);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      backdrop-filter: blur(20px);
    }

    header {
      padding: 14px 22px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.15), transparent 55%);
    }

    .app-title {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .app-title-main {
      font-size: 18px;
      font-weight: 650;
      letter-spacing: 0.03em;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .app-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid var(--accent-soft);
      background: var(--accent-soft);
      color: var(--accent-strong);
    }

    .app-subtitle {
      font-size: 12px;
      color: var(--text-muted);
    }

    .toolbar-tabs {
      display: inline-flex;
      padding: 3px;
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      background: rgba(15,23,42,0.75);
      box-shadow: 0 0 0 1px rgba(15,23,42,0.6);
    }

    .tab-btn {
      border: none;
      background: transparent;
      color: var(--text-muted);
      padding: 6px 14px;
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.18s ease-out;
      white-space: nowrap;
    }

    .tab-btn span.icon {
      font-size: 14px;
    }

    .tab-btn.active {
      background: radial-gradient(circle at top, var(--accent-soft), transparent 70%);
      color: var(--accent-strong);
      box-shadow: 0 0 0 1px var(--accent-soft), 0 10px 25px rgba(15,23,42,0.9);
    }

    .tab-btn:not(.active):hover {
      background: rgba(30,64,175,0.45);
      color: #f9fafb;
    }

    .main {
      display: flex;
      flex: 1;
      padding: 14px 18px 18px;
      gap: 14px;
      overflow: hidden;
    }

    .column {
      display: flex;
      flex-direction: column;
      gap: 12px;
    }

    .sidebar {
      width: 34%;
      min-width: 260px;
    }

    .content {
      flex: 1;
      min-width: 0;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.3), transparent 55%),
                  radial-gradient(circle at bottom right, rgba(15,23,42,0.7), rgba(15,23,42,0.98));
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      padding: 12px 14px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.65);
      position: relative;
      overflow: hidden;
    }

    .card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(135deg, rgba(148,163,184,0.15), transparent 50%);
      mix-blend-mode: soft-light;
      opacity: 0.5;
      pointer-events: none;
    }

    .card-inner {
      position: relative;
      z-index: 1;
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
      gap: 8px;
    }

    .card-title {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.05em;
      text-transform: uppercase;
      color: #cbd5f5;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title-icon {
      font-size: 14px;
    }

    .card-subtitle {
      font-size: 11px;
      color: var(--text-muted);
    }

    .tag-filter-bar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag-filter {
      border: none;
      border-radius: 999px;
      padding: 2px 10px;
      font-size: 11px;
      background: rgba(15,23,42,0.85);
      color: var(--text-muted);
      border: 1px solid var(--border-soft);
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.16s ease-out;
    }

    .tag-filter-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: rgba(148,163,184,0.9);
    }

    .tag-filter-active {
      background: var(--accent-soft);
      color: var(--accent-strong);
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 0 0 1px rgba(56,189,248,0.4);
    }

    .tag-filter-active .tag-filter-dot {
      background: var(--accent-strong);
    }

    .empty-text {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* è§†é¢‘åˆ—è¡¨ */

    .video-list {
      max-height: calc(100vh - 260px);
      overflow: auto;
      padding-right: 4px;
      margin-top: 4px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .helper-card {
      border: 1px dashed var(--border);
    }

    .input-note {
      font-size: 11px;
      color: var(--text-muted);
      margin-top: 4px;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 11px;
      border: 1px solid var(--border);
      background: rgba(15,23,42,0.9);
      color: var(--text-muted);
      box-shadow: 0 10px 24px rgba(0,0,0,0.4);
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--border);
      box-shadow: 0 0 10px rgba(148,163,184,0.4);
    }

    .status-badge.ok {
      border-color: rgba(56,189,248,0.6);
      color: #dbeafe;
      background: rgba(56,189,248,0.12);
    }

    .status-badge.ok .status-dot {
      background: #38bdf8;
      box-shadow: 0 0 12px rgba(56,189,248,0.8);
    }

    .status-badge.error {
      border-color: rgba(248,113,113,0.7);
      background: rgba(185,28,28,0.12);
      color: #fecdd3;
    }

    .status-badge.error .status-dot {
      background: #fb7185;
      box-shadow: 0 0 12px rgba(251,113,133,0.7);
    }

    .video-item {
      display: flex;
      gap: 8px;
      padding: 8px;
      border-radius: var(--radius-md);
      background: rgba(15,23,42,0.85);
      border: 1px solid var(--border-soft);
      cursor: pointer;
      align-items: center;
      transition: all 0.15s ease-out;
    }

    .video-item:hover {
      background: rgba(30,64,175,0.75);
      border-color: rgba(56,189,248,0.8);
      box-shadow: 0 12px 24px rgba(15,23,42,0.85);
    }

    .video-item-active {
      background: linear-gradient(135deg, rgba(56,189,248,0.3), rgba(15,23,42,0.95));
      border-color: rgba(56,189,248,0.9);
      box-shadow: 0 14px 30px rgba(8,47,73,0.9);
    }

    .video-thumb {
      width: 60px;
      height: 38px;
      border-radius: 10px;
      background: radial-gradient(circle at top, #1f2937, #020617);
      position: relative;
      flex-shrink: 0;
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .video-thumb::before {
      content: "";
      position: absolute;
      inset: 2px;
      border-radius: 9px;
      border: 1px solid rgba(148,163,184,0.35);
    }

    .video-thumb-play {
      width: 0;
      height: 0;
      border-left: 10px solid rgba(248,250,252,0.9);
      border-top: 6px solid transparent;
      border-bottom: 6px solid transparent;
      position: relative;
      left: 2px;
      filter: drop-shadow(0 0 8px rgba(15,23,42,0.9));
    }

    .video-meta {
      flex: 1;
      min-width: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .video-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .video-extra {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .video-tags {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      align-items: center;
    }

    .mini-tag {
      font-size: 10px;
      padding: 1px 6px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.5);
      color: #cbd5f5;
      background: rgba(15,23,42,0.9);
    }

    .mini-tag-local {
      background: rgba(56,189,248,0.18);
      border-color: rgba(56,189,248,0.65);
      color: #e0f2fe;
    }

    .counter {
      font-size: 11px;
      color: var(--text-muted);
    }

    /* è§†é¢‘æ’­æ”¾å™¨ */

    .video-player-wrapper {
      border-radius: 18px;
      overflow: hidden;
      background: #000;
      position: relative;
    }

    video {
      width: 100%;
      height: auto;
      max-height: 440px;
      display: block;
      background: #000;
    }

    .video-info {
      margin-top: 8px;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .video-info-title {
      font-size: 15px;
      font-weight: 550;
    }

    .pill-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      flex-wrap: wrap;
    }

    .pill-badge {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      border: 1px solid rgba(148,163,184,0.7);
      background: rgba(15,23,42,0.95);
      color: var(--text-muted);
      display: inline-flex;
      gap: 6px;
      align-items: center;
    }

    .pill-badge-dot {
      width: 8px;
      height: 8px;
      border-radius: 999px;
      background: var(--accent-strong);
      box-shadow: 0 0 10px rgba(56,189,248,0.8);
    }

    .tag-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-top: 4px;
    }

    .tag-chip {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 2px 9px;
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      cursor: default;
    }

    .tag-chip-removable {
      cursor: pointer;
      transition: all 0.16s ease-out;
    }

    .tag-chip-removable:hover {
      background: rgba(239,68,68,0.2);
      border-color: rgba(248,113,113,0.85);
      color: #fecaca;
    }

    .tag-chip-remove-x {
      font-size: 13px;
      line-height: 1;
    }

    .inline-form {
      margin-top: 6px;
      display: flex;
      gap: 6px;
      flex-wrap: nowrap;
      align-items: center;
    }

    .stacked-form {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-top: 8px;
    }

    .input-block {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input {
      border-radius: 999px;
      border: 1px solid var(--border-soft);
      padding: 6px 10px;
      font-size: 12px;
      background: rgba(15,23,42,0.92);
      color: var(--text);
      min-width: 0;
      flex: 1;
    }

    .input::placeholder {
      color: rgba(148,163,184,0.7);
    }

    .btn {
      border-radius: 999px;
      border: 1px solid transparent;
      padding: 6px 12px;
      font-size: 12px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: all 0.16s ease-out;
      background: rgba(30,64,175,0.9);
      color: #e5f2ff;
      box-shadow: 0 10px 24px rgba(15,23,42,0.9);
    }

    .btn:hover {
      background: var(--accent-strong);
      box-shadow: 0 12px 28px rgba(8,47,73,0.95);
    }

    .btn-ghost {
      background: transparent;
      border-color: var(--border-soft);
      color: var(--text-muted);
      box-shadow: none;
    }

    .btn-ghost:hover {
      background: rgba(15,23,42,0.95);
      color: #e5e7eb;
    }

    .btn-danger {
      background: rgba(185,28,28,0.95);
      color: #fee2e2;
      box-shadow: 0 12px 28px rgba(127,29,29,0.8);
    }

    .btn-danger:hover {
      background: rgba(220,38,38,1);
    }

    /* ç…§ç‰‡åŒºåŸŸ */

    .photo-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(90px, 1fr));
      gap: 8px;
      max-height: calc(100vh - 260px);
      overflow: auto;
      padding-right: 4px;
      margin-top: 4px;
    }

    .photo-card {
      position: relative;
      border-radius: 14px;
      overflow: hidden;
      cursor: pointer;
      border: 1px solid rgba(148,163,184,0.35);
      background: #020617;
      transition: all 0.16s ease-out;
    }

    .photo-card::before {
      content: "";
      position: absolute;
      inset: 0;
      background: linear-gradient(to top, rgba(15,23,42,0.85), transparent 50%);
      opacity: 0;
      transition: opacity 0.16s ease-out;
    }

    .photo-card img {
      width: 100%;
      height: 80px;
      object-fit: cover;
      display: block;
      filter: saturate(1.05);
    }

    .photo-card-footer {
      position: absolute;
      inset-inline: 6px;
      bottom: 4px;
      font-size: 10px;
      color: #e5e7eb;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
      opacity: 0;
      transform: translateY(4px);
      transition: all 0.16s ease-out;
    }

    .photo-card-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .photo-card-count {
      font-size: 9px;
      color: #cbd5f5;
      background: rgba(15,23,42,0.9);
      border-radius: 999px;
      padding: 0 6px;
    }

    .photo-card:hover {
      transform: translateY(-2px) scale(1.01);
      box-shadow: 0 14px 30px rgba(15,23,42,0.9);
      border-color: rgba(59,130,246,0.9);
    }

    .photo-card:hover::before {
      opacity: 1;
    }

    .photo-card:hover .photo-card-footer {
      opacity: 1;
      transform: translateY(0);
    }

    .photo-card-active {
      outline: 2px solid rgba(56,189,248,0.95);
      outline-offset: 1px;
      box-shadow: 0 16px 32px rgba(8,47,73,0.9);
    }

    .photo-preview-wrapper {
      border-radius: 18px;
      overflow: hidden;
      background: radial-gradient(circle at top, #1f2937, #020617);
      min-height: 260px;
      position: relative;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .photo-preview-wrapper img {
      max-width: 100%;
      max-height: 440px;
      object-fit: contain;
      display: block;
    }

    .photo-placeholder {
      text-align: center;
      padding: 40px 16px;
      color: var(--text-muted);
      font-size: 13px;
    }

    /* é€šç”¨ */

    .row-between {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
    }

    .muted {
      color: var(--text-muted);
      font-size: 12px;
    }

    .danger-text {
      color: #fecaca;
      font-size: 11px;
    }

    @media (max-width: 900px) {
      body {
        padding: 8px;
      }
      .app {
        border-radius: 16px;
      }
      .main {
        flex-direction: column;
      }
      .sidebar {
        width: 100%;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <header>
    <div class="app-title">
      <div class="app-title-main">
        å¤šåª’ä½“ç®¡ç†ä¸­å¿ƒ
        <span class="app-badge">Demo Â· æœ¬åœ°æ•°æ®</span>
      </div>
      <div class="app-subtitle">ç»Ÿä¸€ç®¡ç†è§†é¢‘ä¸ç…§ç‰‡ï¼Œæ”¯æŒæ ‡ç­¾ç­›é€‰ä¸ç¼–è¾‘</div>
    </div>
    <div class="toolbar-tabs">
      <button class="tab-btn active" data-tab="video" aria-pressed="true">
        <span class="icon">ğŸ¬</span>
        è§†é¢‘ç®¡ç†
      </button>
      <button class="tab-btn" data-tab="photo" aria-pressed="false">
        <span class="icon">ğŸ–¼ï¸</span>
        ç…§ç‰‡ç®¡ç†
      </button>
    </div>
  </header>

  <main class="main">
    <!-- å·¦ä¾§ï¼šåˆ—è¡¨ / ç½‘æ ¼ -->
    <section class="column sidebar">
      <!-- å…¨å±€æ ‡ç­¾ç­›é€‰ -->
      <div class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon">ğŸ·ï¸</span>
                æ ‡ç­¾ç­›é€‰
              </div>
              <div class="card-subtitle">æ ¹æ®æ ‡ç­¾ç­›é€‰å½“å‰æ¨¡å—ä¸­çš„è§†é¢‘æˆ–ç…§ç‰‡</div>
            </div>
          </div>
          <div id="tagFilterBar" class="tag-filter-bar">
            <!-- åŠ¨æ€æ’å…¥æ ‡ç­¾æŒ‰é’® -->
          </div>
        </div>
      </div>

      <div class="card helper-card" id="localVideoCard">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon">ğŸ’»</span>
                æ·»åŠ æœ¬åœ°è§†é¢‘
              </div>
              <div class="card-subtitle">é€‰æ‹©æœ¬åœ°æ–‡ä»¶å¹¶å¿«é€Ÿç”Ÿæˆæ’­æ”¾æ¡ç›®ï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰</div>
            </div>
            <div id="backendStatus" class="status-badge" aria-live="polite">
              <span class="status-dot"></span>
              æœªè¿æ¥åç«¯
            </div>
          </div>
          <form id="localVideoForm" class="stacked-form">
            <div class="input-block">
              <label for="localVideoFile" class="muted">æœ¬åœ°è§†é¢‘æ–‡ä»¶</label>
              <input id="localVideoFile" class="input" type="file" accept="video/*" />
              <div class="input-note">æ–‡ä»¶ä»…åœ¨å½“å‰æµè§ˆå™¨å†…ä½¿ç”¨ï¼Œä¸ä¼šè¢«ä¸Šä¼ ã€‚</div>
            </div>
            <div class="input-block">
              <label for="localVideoTitle" class="muted">æ˜¾ç¤ºæ ‡é¢˜ï¼ˆå¯é€‰ï¼‰</label>
              <input
                id="localVideoTitle"
                class="input"
                type="text"
                placeholder="æœªå¡«å†™æ—¶ä½¿ç”¨æ–‡ä»¶å"
                autocomplete="off"
              />
            </div>
            <div class="input-block">
              <label for="localVideoTags" class="muted">åˆå§‹æ ‡ç­¾ï¼ˆé€—å·åˆ†éš”ï¼Œå¯é€‰ï¼‰</label>
              <input
                id="localVideoTags"
                class="input"
                type="text"
                placeholder="ä¾‹å¦‚ï¼šæœ¬åœ°, å¾…æ•´ç†"
                autocomplete="off"
              />
            </div>
            <div class="input-block">
              <label for="localVideoPath" class="muted">å¯é€‰ï¼šåç«¯ä¿å­˜è·¯å¾„</label>
              <input
                id="localVideoPath"
                class="input"
                type="text"
                placeholder="ä¾‹å¦‚ï¼švideos/my-local-file.mp4"
                autocomplete="off"
              />
              <div class="input-note">å¡«å…¥å¯è¢«æœåŠ¡çš„ç›¸å¯¹è·¯å¾„ä»¥åŒæ­¥åˆ°åç«¯ SQLiteã€‚</div>
            </div>
            <button class="btn" type="submit">
              <span>ï¼‹</span>ç”Ÿæˆæœ¬åœ°æ’­æ”¾æ¡ç›®
            </button>
            <div class="input-note" id="localVideoHint">
              æœ¬åœ°æ¡ç›®åœ¨åˆ·æ–°åä¼šè¢«æ¸…ç©ºï¼›è‹¥å¡«å†™äº†è·¯å¾„ï¼Œæ ‡ç­¾ä¼šåŒæ­¥åˆ°åç«¯ã€‚
            </div>
          </form>
        </div>
      </div>

      <!-- è§†é¢‘åˆ—è¡¨ / ç…§ç‰‡ç½‘æ ¼ -->
      <div class="card" id="sideListCard">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title" id="sideListTitle">
                <span class="card-title-icon">ğŸ¬</span>
                è§†é¢‘æ’­æ”¾åˆ—è¡¨
              </div>
              <div class="card-subtitle" id="sideListSubtitle">
                ç‚¹å‡»é€‰æ‹©è¦æ’­æ”¾çš„è§†é¢‘
              </div>
            </div>
          </div>

          <!-- è§†é¢‘åˆ—è¡¨ -->
          <div id="videoList" class="video-list">
            <!-- åŠ¨æ€æ’å…¥ -->
          </div>

          <!-- ç…§ç‰‡ç½‘æ ¼ -->
          <div id="photoGrid" class="photo-grid" style="display:none;">
            <!-- åŠ¨æ€æ’å…¥ -->
          </div>
        </div>
      </div>
    </section>

    <!-- å³ä¾§ï¼šå†…å®¹åŒº -->
    <section class="column content">
      <!-- è§†é¢‘è§†å›¾ -->
      <div id="videoView" class="card">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon">ğŸ“º</span>
                è§†é¢‘æ’­æ”¾
              </div>
              <div class="card-subtitle">æ”¯æŒåŸºæœ¬æ’­æ”¾æ§åˆ¶ä¸æ ‡ç­¾ç®¡ç†</div>
            </div>
          </div>

          <div class="video-player-wrapper">
            <video id="videoPlayer" controls preload="metadata">
              <!-- åŠ¨æ€è®¾ç½® src -->
              æ‚¨çš„æµè§ˆå™¨ä¸æ”¯æŒ HTML5 è§†é¢‘æ ‡ç­¾ã€‚
            </video>
          </div>

          <div class="video-info">
            <div class="pill-row">
              <div class="video-info-title" id="currentVideoTitle">
                æš‚æ— å¯æ’­æ”¾è§†é¢‘
              </div>
              <div class="pill-badge">
                <span class="pill-badge-dot"></span>
                <span id="currentVideoMeta">0 ä¸ªæ ‡ç­¾</span>
              </div>
            </div>

            <div>
              <div class="muted">è§†é¢‘æ ‡ç­¾</div>
              <div id="currentVideoTags" class="tag-list">
                <!-- åŠ¨æ€æ’å…¥ -->
              </div>
              <form id="addVideoTagForm" class="inline-form">
                <input
                  id="videoTagInput"
                  class="input"
                  type="text"
                  placeholder="ä¸ºå½“å‰è§†é¢‘æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼ˆå›è½¦ç¡®è®¤ï¼‰"
                  autocomplete="off"
                />
                <button class="btn" type="submit">
                  <span>ï¼‹</span>æ·»åŠ æ ‡ç­¾
                </button>
              </form>
              <div class="row-between" style="margin-top:4px;">
                <span class="muted">ç‚¹å‡»æ ‡ç­¾å¯åˆ é™¤</span>
                <button class="btn-ghost btn" type="button" id="deleteCurrentVideoBtn">
                  <span>ğŸ—‘</span>åˆ é™¤å½“å‰è§†é¢‘ï¼ˆæ¼”ç¤ºï¼‰
                </button>
              </div>
              <div class="danger-text">â€» æœ¬ç¤ºä¾‹ä»…ç®¡ç†å‰ç«¯æœ¬åœ°æ•°æ®ï¼Œä¸åŒ…å«çœŸå®ä¸Šä¼  / åˆ é™¤æ¥å£</div>
            </div>
          </div>
        </div>
      </div>

      <!-- ç…§ç‰‡è§†å›¾ -->
      <div id="photoView" class="card" style="display:none;">
        <div class="card-inner">
          <div class="card-header">
            <div>
              <div class="card-title">
                <span class="card-title-icon">ğŸ–¼ï¸</span>
                ç…§ç‰‡é¢„è§ˆ
              </div>
              <div class="card-subtitle">ç‚¹å‡»å·¦ä¾§ç¼©ç•¥å›¾é¢„è§ˆå¤§å›¾å¹¶ç®¡ç†æ ‡ç­¾</div>
            </div>
          </div>

          <div class="photo-preview-wrapper" id="photoPreviewWrapper">
            <!-- åŠ¨æ€æ’å…¥ -->
          </div>

          <div class="video-info" style="margin-top:10px;">
            <div class="pill-row">
              <div class="video-info-title" id="currentPhotoTitle">
                è¯·é€‰æ‹©å·¦ä¾§çš„ä¸€å¼ ç…§ç‰‡
              </div>
              <div class="pill-badge">
                <span class="pill-badge-dot"></span>
                <span id="currentPhotoMeta">0 ä¸ªæ ‡ç­¾</span>
              </div>
            </div>

            <div>
              <div class="muted">ç…§ç‰‡æ ‡ç­¾</div>
              <div id="currentPhotoTags" class="tag-list">
                <!-- åŠ¨æ€æ’å…¥ -->
              </div>
              <form id="addPhotoTagForm" class="inline-form">
                <input
                  id="photoTagInput"
                  class="input"
                  type="text"
                  placeholder="ä¸ºå½“å‰ç…§ç‰‡æ·»åŠ ä¸€ä¸ªæ ‡ç­¾ï¼ˆå›è½¦ç¡®è®¤ï¼‰"
                  autocomplete="off"
                />
                <button class="btn" type="submit">
                  <span>ï¼‹</span>æ·»åŠ æ ‡ç­¾
                </button>
              </form>
              <div class="row-between" style="margin-top:4px;">
                <span class="muted">ç‚¹å‡»æ ‡ç­¾å¯åˆ é™¤</span>
                <button class="btn-ghost btn" type="button" id="deleteCurrentPhotoBtn">
                  <span>ğŸ—‘</span>åˆ é™¤å½“å‰ç…§ç‰‡ï¼ˆæ¼”ç¤ºï¼‰
                </button>
              </div>
              <div class="danger-text">â€» ç…§ç‰‡ä»…ä¸ºæ¼”ç¤ºæ•°æ®ï¼Œè¯·æ›¿æ¢ä¸ºä½ è‡ªå·±çš„èµ„æºè·¯å¾„</div>
            </div>
          </div>
        </div>
      </div>
    </section>
  </main>
</div>

  <script>
    (function () {
      const STORAGE_KEY = "mediaManagerStateV1";
      const BACKEND_URL = "http://localhost:5001";
      const BACKEND_TIMEOUT = 4500;

    /** åˆå§‹æ•°æ®ï¼šè¯·æŒ‰éœ€æ›¿æ¢ä¸ºä½ è‡ªå·±çš„è§†é¢‘ / å›¾ç‰‡è·¯å¾„ */
    const initialState = {
      currentTab: "video",
      videos: [
        {
          id: 1,
          title: "å‰ç«¯å…¥é—¨ - æ’­æ”¾å™¨ç¤ºä¾‹",
          src: "videos/sample1.mp4",
          tags: ["æ•™å­¦", "å‰ç«¯"]
        },
        {
          id: 2,
          title: "äº§å“å®£ä¼ ç‰‡ Demo",
          src: "videos/sample2.mp4",
          tags: ["å®£ä¼ ", "è¥é”€"]
        },
        {
          id: 3,
          title: "ä¼šè®®å½•æ’­ç‰‡æ®µ",
          src: "videos/sample3.mp4",
          tags: ["ä¼šè®®", "å†…éƒ¨"]
        }
      ],
      photos: [
        {
          id: 101,
          title: "æ—¥è½åŸå¸‚æ™¯è§‚",
          src: "photos/photo1.jpg",
          tags: ["é£æ™¯", "åŸå¸‚"]
        },
        {
          id: 102,
          title: "å›¢é˜Ÿåˆå½±",
          src: "photos/photo2.jpg",
          tags: ["å›¢é˜Ÿ", "çºªå¿µ"]
        },
        {
          id: 103,
          title: "äº§å“å®æ‹",
          src: "photos/photo3.jpg",
          tags: ["äº§å“", "å®£ä¼ "]
        }
      ],
      currentVideoId: 1,
      currentPhotoId: 101,
      activeTag: null
    };

    let state = { ...initialState };

    /** DOM å¼•ç”¨ */
    const tabButtons = document.querySelectorAll(".tab-btn");
    const tagFilterBar = document.getElementById("tagFilterBar");
    const sideListTitle = document.getElementById("sideListTitle");
    const sideListSubtitle = document.getElementById("sideListSubtitle");
    const videoListEl = document.getElementById("videoList");
    const photoGridEl = document.getElementById("photoGrid");
    const videoView = document.getElementById("videoView");
    const photoView = document.getElementById("photoView");
    const videoPlayer = document.getElementById("videoPlayer");
    const currentVideoTitle = document.getElementById("currentVideoTitle");
    const currentVideoMeta = document.getElementById("currentVideoMeta");
    const currentVideoTags = document.getElementById("currentVideoTags");
    const videoTagInput = document.getElementById("videoTagInput");
    const addVideoTagForm = document.getElementById("addVideoTagForm");
    const deleteCurrentVideoBtn = document.getElementById("deleteCurrentVideoBtn");
    const localVideoForm = document.getElementById("localVideoForm");
    const localVideoFileInput = document.getElementById("localVideoFile");
    const localVideoTitleInput = document.getElementById("localVideoTitle");
    const localVideoTagsInput = document.getElementById("localVideoTags");
    const localVideoPathInput = document.getElementById("localVideoPath");
    const localVideoHint = document.getElementById("localVideoHint");
    const backendStatus = document.getElementById("backendStatus");

    const photoPreviewWrapper = document.getElementById("photoPreviewWrapper");
    const currentPhotoTitle = document.getElementById("currentPhotoTitle");
    const currentPhotoMeta = document.getElementById("currentPhotoMeta");
    const currentPhotoTags = document.getElementById("currentPhotoTags");
    const photoTagInput = document.getElementById("photoTagInput");
    const addPhotoTagForm = document.getElementById("addPhotoTagForm");
    const deleteCurrentPhotoBtn = document.getElementById("deleteCurrentPhotoBtn");

    /** å·¥å…·å‡½æ•° */

    function escapeHtml(str) {
      return String(str).replace(/[&<>"']/g, function (c) {
        return {
          "&": "&amp;",
          "<": "&lt;",
          ">": "&gt;",
          '"': "&quot;",
          "'": "&#39;"
        }[c] || c;
      });
    }

    function parseTags(raw) {
      return (raw || "")
        .split(/[ï¼Œ,]/)
        .map((t) => t.trim())
        .filter(Boolean);
    }

    function isBlobUrl(src) {
      return typeof src === "string" && src.startsWith("blob:");
    }

    function setLocalVideoHint(message, isError = false) {
      if (!localVideoHint) return;
      localVideoHint.textContent = message;
      localVideoHint.style.color = isError ? "#fecaca" : "var(--text-muted)";
    }

    function setBackendBadge(text, status) {
      if (!backendStatus) return;
      backendStatus.textContent = "";
      const dot = document.createElement("span");
      dot.className = "status-dot";
      backendStatus.appendChild(dot);
      backendStatus.append(document.createTextNode(text));
      backendStatus.classList.remove("ok", "error");
      if (status === "ok") {
        backendStatus.classList.add("ok");
      }
      if (status === "error") {
        backendStatus.classList.add("error");
      }
    }

    const apiClient = (() => {
      let reachable = false;

      async function request(path, options = {}) {
        const controller = new AbortController();
        const timeout = setTimeout(() => controller.abort(), BACKEND_TIMEOUT);
        const headers = {
          "Content-Type": "application/json",
          ...(options.headers || {})
        };
        try {
          const response = await fetch(`${BACKEND_URL}${path}`, {
            ...options,
            headers,
            signal: controller.signal
          });
          if (!response.ok) {
            throw new Error(`è¯·æ±‚å¤±è´¥ï¼š${response.status}`);
          }
          reachable = true;
          return response;
        } catch (err) {
          reachable = false;
          throw err;
        } finally {
          clearTimeout(timeout);
        }
      }

      return {
        isOnline() {
          return reachable;
        },
        async fetchVideos() {
          const res = await request("/api/videos");
          return res.json();
        },
        async saveVideo(payload) {
          const res = await request("/api/videos", {
            method: "POST",
            body: JSON.stringify(payload)
          });
          return res.json();
        },
        async updateVideoTags(id, tags) {
          await request(`/api/videos/${id}/tags`, {
            method: "POST",
            body: JSON.stringify({ tags })
          });
        },
        async deleteVideo(id) {
          await request(`/api/videos/${id}`, { method: "DELETE" });
        },
        markOffline() {
          reachable = false;
        }
      };
    })();

    function loadState() {
      try {
        const stored = localStorage.getItem(STORAGE_KEY);
        if (!stored) return;
        const parsed = JSON.parse(stored);
        state = { ...state, ...parsed };
      } catch (e) {
        console.warn("åŠ è½½æœ¬åœ°çŠ¶æ€å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤æ•°æ®ã€‚", e);
      }
    }

    function saveState() {
      try {
        const persistentVideos = state.videos.filter((v) => !v.isLocal);
        const dataToSave = {
          currentTab: state.currentTab,
          videos: persistentVideos,
          photos: state.photos,
          currentVideoId: state.currentVideoId,
          currentPhotoId: state.currentPhotoId,
          activeTag: state.activeTag
        };
        localStorage.setItem(STORAGE_KEY, JSON.stringify(dataToSave));
      } catch (e) {
        console.warn("ä¿å­˜æœ¬åœ°çŠ¶æ€å¤±è´¥ã€‚", e);
      }
    }

    function getCurrentVideo() {
      return state.videos.find((v) => v.id === state.currentVideoId) || null;
    }

    function getCurrentPhoto() {
      return state.photos.find((p) => p.id === state.currentPhotoId) || null;
    }

    function syncCurrentSelection() {
      if (!getCurrentVideo() && state.videos.length > 0) {
        state.currentVideoId = state.videos[0].id;
      }
      if (!getCurrentPhoto() && state.photos.length > 0) {
        state.currentPhotoId = state.photos[0].id;
      }
    }

    function getTagsForCurrentTab() {
      const list = state.currentTab === "video" ? state.videos : state.photos;
      const set = new Set();
      list.forEach((item) => {
        (item.tags || []).forEach((t) => set.add(t));
      });
      return Array.from(set).sort();
    }

    function normalizeBackendVideo(raw) {
      const backendId = Number(raw.id);
      const tags = Array.isArray(raw.tags)
        ? raw.tags.filter(Boolean)
        : [];
      return {
        id: backendId ? backendId + 1000000 : Date.now(),
        backendId,
        title: raw.title || "æœªå‘½åè§†é¢‘",
        src: raw.src || "",
        tags,
        isLocal: false,
        fromBackend: true
      };
    }

    function mergeBackendVideos(list) {
      if (!Array.isArray(list)) return;
      let changed = false;
      list.forEach((raw) => {
        const video = normalizeBackendVideo(raw);
        const existed = state.videos.find((v) => v.backendId === video.backendId);
        if (existed) {
          existed.title = video.title;
          existed.src = video.src;
          existed.tags = video.tags;
        } else {
          state.videos.push(video);
        }
        changed = true;
      });
      if (changed) {
        syncCurrentSelection();
        renderAll();
        saveState();
      }
    }

    async function syncVideoTagsToBackend(video) {
      if (!video || !video.backendId) return;
      try {
        await apiClient.updateVideoTags(video.backendId, video.tags || []);
        setBackendBadge("å·²è¿æ¥åç«¯ Â· æ ‡ç­¾å·²æ›´æ–°", "ok");
      } catch (err) {
        setBackendBadge("æ ‡ç­¾æœªåŒæ­¥ï¼šåç«¯ä¸å¯ç”¨", "error");
      }
    }

    async function maybePersistVideo(video, providedPath) {
      if (!video) return;
      const chosenPath = providedPath || video.src;
      if (isBlobUrl(chosenPath)) return;
      const previousId = video.id;
      try {
        const payload = await apiClient.saveVideo({
          title: video.title,
          src: chosenPath,
          tags: video.tags || [],
          is_local: !!video.isLocal
        });
        const data = payload && (payload.data || payload);
        if (data && data.id) {
          video.backendId = Number(data.id);
          video.id = video.backendId + 1000000;
          video.isLocal = false;
          if (state.currentVideoId === previousId) {
            state.currentVideoId = video.id;
          }
          setBackendBadge("å·²åŒæ­¥åˆ°åç«¯", "ok");
          saveState();
          renderAll();
        }
      } catch (err) {
        setBackendBadge("æ— æ³•åŒæ­¥åˆ°åç«¯ï¼Œå·²ä¿æŒæœ¬åœ°æ’­æ”¾", "error");
      }
    }

    /** æ¸²æŸ“å‡½æ•° */

    function renderTagFilterBar() {
      const tags = getTagsForCurrentTab();
      if (tags.length === 0) {
        tagFilterBar.innerHTML =
          '<span class="empty-text">å½“å‰æ¨¡å—æš‚æ— æ ‡ç­¾ï¼Œå¯å…ˆä¸ºè§†é¢‘ / ç…§ç‰‡æ·»åŠ æ ‡ç­¾</span>';
        return;
      }

      let html = "";
      const isActiveAll = !state.activeTag;
      html += `
        <button class="tag-filter ${isActiveAll ? "tag-filter-active" : ""}"
                type="button"
                data-tag="__all">
          <span class="tag-filter-dot"></span>
          å…¨éƒ¨
        </button>
      `;

      tags.forEach((tag) => {
        const encoded = encodeURIComponent(tag);
        const isActive = state.activeTag === tag;
        html += `
          <button class="tag-filter ${
            isActive ? "tag-filter-active" : ""
          }" type="button" data-tag="${encoded}">
            <span class="tag-filter-dot"></span>
            ${escapeHtml(tag)}
          </button>
        `;
      });

      tagFilterBar.innerHTML = html;
    }

    function renderSideList() {
      const isVideoTab = state.currentTab === "video";

      if (isVideoTab) {
        sideListTitle.innerHTML = '<span class="card-title-icon">ğŸ¬</span> è§†é¢‘æ’­æ”¾åˆ—è¡¨';
        sideListSubtitle.textContent = "ç‚¹å‡»æ¡ç›®å¼€å§‹æ’­æ”¾";
        videoListEl.style.display = "flex";
        photoGridEl.style.display = "none";

        let videos = state.videos.slice();
        if (state.activeTag) {
          videos = videos.filter((v) => (v.tags || []).includes(state.activeTag));
        }

        if (videos.length === 0) {
          videoListEl.innerHTML =
            '<div class="empty-text">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯ç”¨è§†é¢‘ã€‚</div>';
          return;
        }

        const html = videos
          .map((v) => {
            const isActive = v.id === state.currentVideoId;
            const tagHtml = (v.tags || [])
              .map((t) => `<span class="mini-tag">${escapeHtml(t)}</span>`)
              .join("");
            const localBadge = v.isLocal
              ? '<span class="mini-tag mini-tag-local">æœ¬åœ°</span>'
              : "";
            const combinedTags = `${localBadge}${
              tagHtml || '<span class="mini-tag" style="opacity:0.7;">æ— æ ‡ç­¾</span>'
            }`;

            return `
              <div class="video-item ${
                isActive ? "video-item-active" : ""
              }" data-video-id="${v.id}">
                <div class="video-thumb">
                  <div class="video-thumb-play"></div>
                </div>
                <div class="video-meta">
                  <div class="video-title" title="${escapeHtml(v.title)}">
                    ${escapeHtml(v.title)}
                  </div>
                  <div class="video-extra">
                    <div class="video-tags">
                      ${combinedTags}
                    </div>
                    <span class="counter">${
                      v.tags ? v.tags.length : 0
                    } æ ‡ç­¾</span>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");

        videoListEl.innerHTML = html;
      } else {
        sideListTitle.innerHTML = '<span class="card-title-icon">ğŸ–¼ï¸</span> ç…§ç‰‡é›†åˆ';
        sideListSubtitle.textContent = "ç‚¹å‡»ç¼©ç•¥å›¾é¢„è§ˆ";
        videoListEl.style.display = "none";
        photoGridEl.style.display = "grid";

        let photos = state.photos.slice();
        if (state.activeTag) {
          photos = photos.filter((p) => (p.tags || []).includes(state.activeTag));
        }

        if (photos.length === 0) {
          photoGridEl.innerHTML =
            '<div class="empty-text">å½“å‰ç­›é€‰æ¡ä»¶ä¸‹æ²¡æœ‰å¯ç”¨ç…§ç‰‡ã€‚</div>';
          return;
        }

        const html = photos
          .map((p) => {
            const isActive = p.id === state.currentPhotoId;
            return `
              <div class="photo-card ${
                isActive ? "photo-card-active" : ""
              }" data-photo-id="${p.id}">
                <img src="${escapeHtml(p.src)}" alt="${escapeHtml(p.title)}" />
                <div class="photo-card-footer">
                  <span class="photo-card-title" title="${escapeHtml(p.title)}">
                    ${escapeHtml(p.title)}
                  </span>
                  <span class="photo-card-count">${
                    p.tags ? p.tags.length : 0
                  } æ ‡ç­¾</span>
                </div>
              </div>
            `;
          })
          .join("");

        photoGridEl.innerHTML = html;
      }
    }

    function renderVideoView() {
      if (state.currentTab !== "video") {
        videoView.style.display = "none";
        return;
      }
      videoView.style.display = "block";

      const video = getCurrentVideo();
      if (!video) {
        videoPlayer.removeAttribute("src");
        videoPlayer.load();
        currentVideoTitle.textContent = "æš‚æ— å¯æ’­æ”¾è§†é¢‘";
        currentVideoMeta.textContent = "0 ä¸ªæ ‡ç­¾";
        currentVideoTags.innerHTML =
          '<span class="empty-text">è¯·å…ˆåœ¨å·¦ä¾§æ·»åŠ è§†é¢‘æ•°æ®</span>';
        return;
      }

      if (videoPlayer.getAttribute("src") !== video.src) {
        videoPlayer.setAttribute("src", video.src);
        videoPlayer.load();
      }

      currentVideoTitle.textContent = video.title;
      const tagCount = video.tags ? video.tags.length : 0;
      const metaSuffix = video.isLocal
        ? " Â· æœ¬åœ°æ–‡ä»¶"
        : video.fromBackend
          ? " Â· åç«¯åŒæ­¥"
          : "";
      currentVideoMeta.textContent = `${tagCount} ä¸ªæ ‡ç­¾${metaSuffix}`;

      if (!video.tags || video.tags.length === 0) {
        currentVideoTags.innerHTML =
          '<span class="empty-text">æš‚æ— æ ‡ç­¾ï¼Œå¯åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­æ·»åŠ </span>';
      } else {
        const html = video.tags
          .map((t, index) => {
            return `
              <button
                type="button"
                class="tag-chip tag-chip-removable"
                data-media-type="video"
                data-media-id="${video.id}"
                data-tag-index="${index}">
                <span>${escapeHtml(t)}</span>
                <span class="tag-chip-remove-x" aria-hidden="true">Ã—</span>
              </button>
            `;
          })
          .join("");
        currentVideoTags.innerHTML = html;
      }
    }

    function renderPhotoView() {
      if (state.currentTab !== "photo") {
        photoView.style.display = "none";
        return;
      }
      photoView.style.display = "block";

      const photo = getCurrentPhoto();

      if (!photo) {
        photoPreviewWrapper.innerHTML =
          '<div class="photo-placeholder">æš‚æ— å¯é¢„è§ˆçš„ç…§ç‰‡</div>';
        currentPhotoTitle.textContent = "æš‚æ— ç…§ç‰‡";
        currentPhotoMeta.textContent = "0 ä¸ªæ ‡ç­¾";
        currentPhotoTags.innerHTML =
          '<span class="empty-text">è¯·å…ˆåœ¨å·¦ä¾§æ·»åŠ ç…§ç‰‡æ•°æ®</span>';
        return;
      }

      photoPreviewWrapper.innerHTML = `
        <img src="${escapeHtml(photo.src)}" alt="${escapeHtml(photo.title)}" />
      `;
      currentPhotoTitle.textContent = photo.title;
      const tagCount = photo.tags ? photo.tags.length : 0;
      currentPhotoMeta.textContent = `${tagCount} ä¸ªæ ‡ç­¾`;

      if (!photo.tags || photo.tags.length === 0) {
        currentPhotoTags.innerHTML =
          '<span class="empty-text">æš‚æ— æ ‡ç­¾ï¼Œå¯åœ¨ä¸‹æ–¹è¾“å…¥æ¡†ä¸­æ·»åŠ </span>';
      } else {
        const html = photo.tags
          .map((t, index) => {
            return `
              <button
                type="button"
                class="tag-chip tag-chip-removable"
                data-media-type="photo"
                data-media-id="${photo.id}"
                data-tag-index="${index}">
                <span>${escapeHtml(t)}</span>
                <span class="tag-chip-remove-x" aria-hidden="true">Ã—</span>
              </button>
            `;
          })
          .join("");
        currentPhotoTags.innerHTML = html;
      }
    }

    function renderTabs() {
      tabButtons.forEach((btn) => {
        const tab = btn.getAttribute("data-tab");
        const isActive = tab === state.currentTab;
        btn.classList.toggle("active", isActive);
        btn.setAttribute("aria-pressed", String(isActive));
      });
    }

    function renderAll() {
      syncCurrentSelection();
      renderTabs();
      renderTagFilterBar();
      renderSideList();
      renderVideoView();
      renderPhotoView();
    }

    async function bootstrapBackendSync() {
      setBackendBadge("æ­£åœ¨è¿æ¥åç«¯...", null);
      try {
        const payload = await apiClient.fetchVideos();
        const list = Array.isArray(payload?.data)
          ? payload.data
          : Array.isArray(payload)
            ? payload
            : [];
        mergeBackendVideos(list);
        setBackendBadge(`å·²è¿æ¥åç«¯ Â· ${list.length} æ¡è§†é¢‘`, "ok");
      } catch (err) {
        apiClient.markOffline();
        setBackendBadge("æœªæ£€æµ‹åˆ°åç«¯ï¼Œå½“å‰ä¸ºæœ¬åœ°æ¨¡å¼", "error");
      }
    }

    /** äº‹ä»¶ç»‘å®š */

    // Tab åˆ‡æ¢
    tabButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const tab = btn.getAttribute("data-tab");
        if (tab === state.currentTab) return;
        state.currentTab = tab;
        state.activeTag = null; // åˆ‡æ¢æ¨¡å—æ—¶æ¸…ç©ºæ ‡ç­¾ç­›é€‰
        renderAll();
        saveState();
      });
    });

    // æ ‡ç­¾ç­›é€‰ç‚¹å‡»
    tagFilterBar.addEventListener("click", (e) => {
      const btn = e.target.closest("button[data-tag]");
      if (!btn) return;
      const raw = btn.getAttribute("data-tag");
      if (raw === "__all") {
        state.activeTag = null;
      } else {
        try {
          state.activeTag = decodeURIComponent(raw);
        } catch (err) {
          state.activeTag = null;
        }
      }
      renderAll();
      saveState();
    });

    // è§†é¢‘åˆ—è¡¨ç‚¹å‡» -> åˆ‡æ¢å½“å‰è§†é¢‘
    videoListEl.addEventListener("click", (e) => {
      const item = e.target.closest("[data-video-id]");
      if (!item) return;
      const id = Number(item.getAttribute("data-video-id"));
      if (!id || id === state.currentVideoId) return;
      state.currentVideoId = id;
      renderAll();
      saveState();
    });

    // ç…§ç‰‡ç½‘æ ¼ç‚¹å‡» -> åˆ‡æ¢å½“å‰ç…§ç‰‡
    photoGridEl.addEventListener("click", (e) => {
      const item = e.target.closest("[data-photo-id]");
      if (!item) return;
      const id = Number(item.getAttribute("data-photo-id"));
      if (!id || id === state.currentPhotoId) return;
      state.currentPhotoId = id;
      renderAll();
      saveState();
    });

    // å½“å‰è§†é¢‘æ ‡ç­¾ï¼šåˆ é™¤
    currentVideoTags.addEventListener("click", (e) => {
      const btn = e.target.closest(".tag-chip-removable");
      if (!btn) return;
      const mediaType = btn.getAttribute("data-media-type");
      const mediaId = Number(btn.getAttribute("data-media-id"));
      const tagIndex = Number(btn.getAttribute("data-tag-index"));
      if (mediaType !== "video" || isNaN(mediaId) || isNaN(tagIndex)) return;

      const video = state.videos.find((v) => v.id === mediaId);
      if (!video || !video.tags) return;
      if (tagIndex < 0 || tagIndex >= video.tags.length) return;

      video.tags.splice(tagIndex, 1);
      syncVideoTagsToBackend(video);
      renderAll();
      saveState();
    });

    // å½“å‰ç…§ç‰‡æ ‡ç­¾ï¼šåˆ é™¤
    currentPhotoTags.addEventListener("click", (e) => {
      const btn = e.target.closest(".tag-chip-removable");
      if (!btn) return;
      const mediaType = btn.getAttribute("data-media-type");
      const mediaId = Number(btn.getAttribute("data-media-id"));
      const tagIndex = Number(btn.getAttribute("data-tag-index"));
      if (mediaType !== "photo" || isNaN(mediaId) || isNaN(tagIndex)) return;

      const photo = state.photos.find((p) => p.id === mediaId);
      if (!photo || !photo.tags) return;
      if (tagIndex < 0 || tagIndex >= photo.tags.length) return;

      photo.tags.splice(tagIndex, 1);
      renderAll();
      saveState();
    });

    // ä¸ºå½“å‰è§†é¢‘æ·»åŠ æ ‡ç­¾
    addVideoTagForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const value = (videoTagInput.value || "").trim();
      if (!value) return;
      const video = getCurrentVideo();
      if (!video) return;
      video.tags = video.tags || [];
      if (!video.tags.includes(value)) {
        video.tags.push(value);
      }
      syncVideoTagsToBackend(video);
      videoTagInput.value = "";
      renderAll();
      saveState();
    });

    // æ·»åŠ æœ¬åœ°è§†é¢‘ï¼ˆä»…å½“å‰ä¼šè¯æœ‰æ•ˆï¼‰
    localVideoForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const file = localVideoFileInput.files[0];
      if (!file) {
        setLocalVideoHint("è¯·é€‰æ‹©ä¸€ä¸ªæœ¬åœ°è§†é¢‘æ–‡ä»¶ã€‚", true);
        return;
      }

      const title = (localVideoTitleInput.value || file.name).trim();
      const tags = parseTags(localVideoTagsInput.value);
      const manualPath = (localVideoPathInput.value || "").trim();
      const newVideo = {
        id: Date.now(),
        title: title || file.name,
        src: URL.createObjectURL(file),
        tags,
        isLocal: true,
        fileName: file.name,
        fileSize: file.size,
        persistedSrc: manualPath || null
      };

      state.videos.unshift(newVideo);
      state.currentVideoId = newVideo.id;
      renderAll();
      saveState();
      localVideoForm.reset();
      setLocalVideoHint(
        manualPath
          ? "å·²åŠ è½½æœ¬åœ°è§†é¢‘ï¼Œå¡«å†™çš„è·¯å¾„å°†ç”¨äºåç«¯åŒæ­¥"
          : "å·²åŠ è½½æœ¬åœ°è§†é¢‘ï¼Œåˆ·æ–°åéœ€é‡æ–°é€‰æ‹©æ–‡ä»¶ã€‚"
      );

      if (manualPath) {
        maybePersistVideo(newVideo, manualPath);
      }
    });

    // ä¸ºå½“å‰ç…§ç‰‡æ·»åŠ æ ‡ç­¾
    addPhotoTagForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const value = (photoTagInput.value || "").trim();
      if (!value) return;
      const photo = getCurrentPhoto();
      if (!photo) return;
      photo.tags = photo.tags || [];
      if (!photo.tags.includes(value)) {
        photo.tags.push(value);
      }
      photoTagInput.value = "";
      renderAll();
      saveState();
    });

    // åˆ é™¤å½“å‰è§†é¢‘ï¼ˆä»…å‰ç«¯ç¤ºä¾‹ï¼‰
    deleteCurrentVideoBtn.addEventListener("click", () => {
      const video = getCurrentVideo();
      if (!video) return;
      if (!confirm(`ç¡®å®šè¦ä»åˆ—è¡¨ä¸­ç§»é™¤è§†é¢‘ã€Œ${video.title}ã€å—ï¼Ÿ\nï¼ˆä»…å‰ç«¯æœ¬åœ°æ¼”ç¤ºï¼‰`)) {
        return;
      }
      state.videos = state.videos.filter((v) => v.id !== video.id);
      if (video.backendId) {
        apiClient
          .deleteVideo(video.backendId)
          .then(() => setBackendBadge("åç«¯å·²åˆ é™¤è§†é¢‘", "ok"))
          .catch(() => setBackendBadge("åç«¯åˆ é™¤å¤±è´¥ï¼Œå·²åœ¨å‰ç«¯ç§»é™¤", "error"));
      }
      syncCurrentSelection();
      renderAll();
      saveState();
    });

    // åˆ é™¤å½“å‰ç…§ç‰‡ï¼ˆä»…å‰ç«¯ç¤ºä¾‹ï¼‰
    deleteCurrentPhotoBtn.addEventListener("click", () => {
      const photo = getCurrentPhoto();
      if (!photo) return;
      if (!confirm(`ç¡®å®šè¦ä»åˆ—è¡¨ä¸­ç§»é™¤ç…§ç‰‡ã€Œ${photo.title}ã€å—ï¼Ÿ\nï¼ˆä»…å‰ç«¯æœ¬åœ°æ¼”ç¤ºï¼‰`)) {
        return;
      }
      state.photos = state.photos.filter((p) => p.id !== photo.id);
      syncCurrentSelection();
      renderAll();
      saveState();
    });

    /** åˆå§‹åŒ– */
    loadState();
    syncCurrentSelection();
    renderAll();
    bootstrapBackendSync();
  })();
</script>
</body>
</html>
